# Trade On Actions
# These on_actions trigger events related to trade
# Hook into the standard on_monthly_pulse to run our trade calculations
on_monthly_pulse = {
	on_actions = {
		on_monthly_trade_pulse
	}
}

# Monthly pulse for trade calculations
on_monthly_trade_pulse = {
	# This is called by hooking into the on_monthly_pulse
	effect = {
		# Execute the simplified trade flow calculation only if we have trade routes
		# This check improves performance for games without active trade
		if = {
			limit = {
				any_title = {
					tier = county
					has_county_flag = on_silk_road
				}
			}
			# Execute the simplified trade flow calculation
			calculate_basic_trade_income_effect = yes
			# Update county prosperity based on trade route status
			# Only process counties on the Silk Road for better performance
			every_title = {
				limit = {
					tier = county
					has_county_flag = on_silk_road
				}
				# Apply trade prosperity effects to counties on the Silk Road
				apply_trade_prosperity_effect = yes
				# Check for status changes - only if there are active or disrupted routes
				# This significantly reduces unnecessary checks
				if = {
					limit = {
						OR = {
							has_county_flag = on_active_trade_route
							has_county_flag = on_disrupted_trade_route
							# Also check prosperity flags to catch prosperity changes
							has_county_flag = trade_prosperity_low
							has_county_flag = trade_prosperity_medium
							has_county_flag = trade_prosperity_high
						}
					}
					# Check if the status has changed
					on_action = trade_status_change
				}
			}
		}
	}
}

# This is triggered when a county is occupied
# County scope
on_county_occupied = {
	on_actions = {
		trade_county_occupied
	}
}

# Custom on_action for county occupation
# County scope
trade_county_occupied = {
	effect = {
		# Only check counties on trade routes
		if = {
			limit = {
				has_county_flag = on_silk_road
			}
			# Mark the trade route as disrupted if it was active
			if = {
				limit = {
					has_county_flag = on_active_trade_route
				}
				# Remove active flag
				remove_county_flag = on_active_trade_route
				# Add disrupted flag
				set_county_flag = on_disrupted_trade_route
				# Notify about disruption
				on_action = trade_status_change
			}
		}
	}
}

# This is triggered when a holding building is constructed
# Holding scope
on_holding_building_constructed = {
	on_actions = {
		trade_building_constructed
	}
}

# Custom on_action for building construction
# Holding scope
trade_building_constructed = {
	effect = {
		# Check if this is a trade building
		if = {
			limit = {
				OR = {
					has_building = market_square
					has_building = trading_post
					has_building = caravanserai
				}
			}
			# Update trade status for the county
			county = {
				# If on a trade route, may activate it
				if = {
					limit = {
						has_county_flag = on_silk_road
						has_county_flag = on_disrupted_trade_route
						NOT = {
							has_county_flag = on_active_trade_route
						}
					}
					# Remove disrupted flag
					remove_county_flag = on_disrupted_trade_route
					# Add active flag
					set_county_flag = on_active_trade_route
					# Notify about activation
					on_action = trade_status_change
				}
			}
		}
	}
}

# Triggered when a county changes status
# County scope
trade_status_change = {
	random_events = {
		# Add event references here when trade events are implemented
		# Events for active routes becoming prosperous
		100 = 0
		# fallback = trade_fallback
	}
	events = {
		# Status change notification events
		id = trade_events.0100
	}
}

# Custom on_action for trade events
# Character scope
trade_events_random = {
	random_events = {
		# Prosperity events
		100 = trade_events.0201
		# Caravan events
		100 = trade_events.0202
		# Merchant events
		100 = trade_events.0203
	}
}

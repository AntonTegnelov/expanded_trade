# Trade Route Effects
# These scripted effects handle trade route validation and travel plan compatibility
# Validates if two counties are properly connected for trade
validate_trade_route_connection_effect = {
	# $FROM_COUNTY$ = First county
	# $TO_COUNTY$ = Second county
	# First check if the route is already validated to avoid redundant calculations
	if = {
		limit = {
			$FROM_COUNTY$ = {
				has_variable = trade_route_to_$TO_COUNTY$_valid
			}
		}
		# Skip calculation if already validated
		return = yes
	}
	# Check if the counties are adjacent (using existing province connection system)
	if = {
		limit = {
			$FROM_COUNTY$ = {
				is_adjacent_to_county = $TO_COUNTY$
			}
		}
		# Counties are adjacent - connection is valid
		$FROM_COUNTY$ = {
			set_variable = {
				name = trade_route_to_$TO_COUNTY$_valid
				value = yes
			}
			set_variable = {
				name = trade_route_to_$TO_COUNTY$_connection_type
				value = "land"
			}
			set_county_flag = on_active_trade_route
		}
		$TO_COUNTY$ = {
			set_variable = {
				name = trade_route_to_$FROM_COUNTY$_valid
				value = yes
			}
			set_variable = {
				name = trade_route_to_$FROM_COUNTY$_connection_type
				value = "land"
			}
			set_county_flag = on_active_trade_route
		}
	}
	else = {
		# Counties are not directly adjacent - check for sea or river connections
		# Check sea connection using coastal counties
		if = {
			limit = {
				$FROM_COUNTY$ = {
					has_county_flag = coastal_county
				}
				$TO_COUNTY$ = {
					has_county_flag = coastal_county
				}
				# Check if counties are in the same or adjacent sea zones
				# This leverages the existing province connection system's sea zone data
				OR = {
					$FROM_COUNTY$ = {
						is_in_same_sea_zone_as = $TO_COUNTY$
					}
					$FROM_COUNTY$ = {
						is_in_adjacent_sea_zone_to = $TO_COUNTY$
					}
				}
			}
			# Counties are connected by sea - connection is valid
			$FROM_COUNTY$ = {
				set_variable = {
					name = trade_route_to_$TO_COUNTY$_valid
					value = yes
				}
				set_variable = {
					name = trade_route_to_$TO_COUNTY$_connection_type
					value = "sea"
				}
				set_county_flag = on_active_trade_route
			}
			$TO_COUNTY$ = {
				set_variable = {
					name = trade_route_to_$FROM_COUNTY$_valid
					value = yes
				}
				set_variable = {
					name = trade_route_to_$FROM_COUNTY$_connection_type
					value = "sea"
				}
				set_county_flag = on_active_trade_route
			}
		}
		# Check river connection
		else_if = {
			limit = {
				$FROM_COUNTY$ = {
					has_river = yes
				}
				$TO_COUNTY$ = {
					has_river = yes
				}
				# Check if counties share the same river
				# This leverages the existing river system data
				$FROM_COUNTY$ = {
					is_connected_by_river_to = $TO_COUNTY$
				}
			}
			# Counties are connected by river - connection is valid
			$FROM_COUNTY$ = {
				set_variable = {
					name = trade_route_to_$TO_COUNTY$_valid
					value = yes
				}
				set_variable = {
					name = trade_route_to_$TO_COUNTY$_connection_type
					value = "river"
				}
				set_county_flag = on_active_trade_route
			}
			$TO_COUNTY$ = {
				set_variable = {
					name = trade_route_to_$FROM_COUNTY$_valid
					value = yes
				}
				set_variable = {
					name = trade_route_to_$FROM_COUNTY$_connection_type
					value = "river"
				}
				set_county_flag = on_active_trade_route
			}
		}
		else = {
			# Counties are not connected - connection is invalid
			$FROM_COUNTY$ = {
				set_variable = {
					name = trade_route_to_$TO_COUNTY$_valid
					value = no
				}
			}
			$TO_COUNTY$ = {
				set_variable = {
					name = trade_route_to_$FROM_COUNTY$_valid
					value = no
				}
			}
		}
	}
	# Apply appropriate modifiers based on connection type
	if = {
		limit = {
			$FROM_COUNTY$ = {
				has_variable = trade_route_to_$TO_COUNTY$_valid
				var:trade_route_to_$TO_COUNTY$_valid = yes
			}
		}
		# Apply efficiency modifiers based on connection type
		if = {
			limit = {
				$FROM_COUNTY$ = {
					var:trade_route_to_$TO_COUNTY$_connection_type = "land"
				}
			}
			$FROM_COUNTY$ = {
				set_variable = {
					name = trade_route_to_$TO_COUNTY$_efficiency
					value = land_trade_route_modifier
				}
			}
			$TO_COUNTY$ = {
				set_variable = {
					name = trade_route_to_$FROM_COUNTY$_efficiency
					value = land_trade_route_modifier
				}
			}
		}
		else_if = {
			limit = {
				$FROM_COUNTY$ = {
					var:trade_route_to_$TO_COUNTY$_connection_type = "sea"
				}
			}
			$FROM_COUNTY$ = {
				set_variable = {
					name = trade_route_to_$TO_COUNTY$_efficiency
					value = coastal_trade_route_modifier
				}
			}
			$TO_COUNTY$ = {
				set_variable = {
					name = trade_route_to_$FROM_COUNTY$_efficiency
					value = coastal_trade_route_modifier
				}
			}
		}
		else_if = {
			limit = {
				$FROM_COUNTY$ = {
					var:trade_route_to_$TO_COUNTY$_connection_type = "river"
				}
			}
			$FROM_COUNTY$ = {
				set_variable = {
					name = trade_route_to_$TO_COUNTY$_efficiency
					value = river_trade_route_modifier
				}
			}
			$TO_COUNTY$ = {
				set_variable = {
					name = trade_route_to_$FROM_COUNTY$_efficiency
					value = river_trade_route_modifier
				}
			}
		}
	}
}

# Sets up travel plan compatibility for trade caravans
setup_trade_caravan_travel_plan_effect = {
	# $FROM_NODE$ = Starting trade node
	# $TO_NODE$ = Destination trade node
	# $CARAVAN_LEADER$ = Character leading the caravan (optional)
	# First determine if we have a caravan leader specified
	if = {
		limit = {
			exists = $CARAVAN_LEADER$
		}
		# Use the character as caravan leader
		$CARAVAN_LEADER$ = {
			create_travel_plan = {
				target = $TO_NODE$.county.barony
				on_arrival = trade_caravan_arrival_on_action
			}
		}
	}
	else = {
		# Generate a random merchant character to lead caravan
		$FROM_NODE$.county.holder = {
			create_character = {
				name = "RANDOM_TRADER_NAME"				# Using a simple name placeholder
				faith = this.faith
				culture = this.culture
				age = {
					min = 25
					max = 55
				}
				trait = gregarious
				traits = {
					diligent
					shrewd
				}
				employer = this
				save_scope_as = caravan_leader
			}
		}
		# Use the generated character as caravan leader
		scope:caravan_leader = {
			create_travel_plan = {
				target = $TO_NODE$.county.barony
				on_arrival = trade_caravan_arrival_on_action
			}
		}
	}
}

# Calculates trade prosperity based on county development
calculate_trade_prosperity_effect = {
	# $COUNTY$ = County to calculate prosperity for
	# Trade prosperity is based on development level and trade route status
	$COUNTY$ = {
		# Base value from development
		set_variable = {
			name = trade_prosperity_level
			value = development_level
		}
		# Bonus if on active trade route
		if = {
			limit = {
				has_county_flag = on_active_trade_route
			}
			change_variable = {
				name = trade_prosperity_level
				add = 2
			}
		}
		# Penalty if trade route is disrupted
		if = {
			limit = {
				has_county_flag = on_disrupted_trade_route
			}
			change_variable = {
				name = trade_prosperity_level
				subtract = 1
			}
		}
		# Ensure prosperity level doesn't go negative
		if = {
			limit = {
				var:trade_prosperity_level < 0
			}
			set_variable = {
				name = trade_prosperity_level
				value = 0
			}
		}
	}
}

# Update trade node controller based on county owner
update_trade_node_controller_effect = {
	# $NODE_ID$ = ID of the trade node to update
	# Find the trade node's county and update controller
	every_county = {
		limit = {
			$NODE_ID$ = {
				county = this
			}
		}
		# Set the controller to the county holder
		$NODE_ID$ = {
			set_variable = {
				name = controller
				value = root.holder
			}
		}
	}
}

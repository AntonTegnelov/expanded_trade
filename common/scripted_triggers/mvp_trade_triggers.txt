# MVP Trade Triggers
# These scripted triggers provide essential checks for trade functionality
# Basic version focused on Silk Road trade and minimal economy
# Checks if a county is on the Silk Road
is_on_silk_road_trigger = {
	# County can be directly on the route or close enough to benefit
	OR = {
		# Direct Silk Road county (has the flag)
		has_county_flag = on_silk_road
		# County is within trading distance of a Silk Road node
		any_neighboring_county = {
			has_county_flag = on_silk_road
		}
		# County has a silk road trade node
		any_trade_node = {
			OR = {
				# Exact node matching
				node_id = xian_node
				node_id = dunhuang_node
				node_id = kashgar_node
				node_id = samarkand_node
				node_id = bukhara_node
				node_id = merv_node
				node_id = nishapur_node
				node_id = rayy_node
				node_id = baghdad_node
				node_id = mosul_node
				node_id = aleppo_node
				node_id = antioch_node
				node_id = constantinople_node
			}
		}
	}
}

# Checks if a county produces a specific trade good
has_trade_good_trigger = {
	# $TRADE_GOOD$ = ID of the trade good to check for
	# If a specific trade good is provided, check for that
	OR = {
		# County has the specific trade good flag
		has_county_flag = produces_$TRADE_GOOD$
		# County terrain matches production requirements
		AND = {
			# The check works with a scope to the county
			$TRADE_GOOD$ = {
				# Check if county terrain matches any of the production terrain types
				any_in_list = {
					variable = production_terrain
					this = {
						root = {
							terrain = $VALUE$
						}
					}
				}
			}
		}
		# County has a building that produces this good
		has_building = $TRADE_GOOD$_production
	}
}

# Checks if a county has a specific level of trade prosperity
has_trade_prosperity_trigger = {
	# $LEVEL$ = Optional prosperity level to check for (low, medium, high)
	# If no level is specified, checks for any prosperity
	OR = {
		# Check for any prosperity if no level specified
		AND = {
			NOT = {
				is_variable_set = $LEVEL$
			}
			OR = {
				has_modifier = low_trade_prosperity
				has_modifier = medium_trade_prosperity
				has_modifier = high_trade_prosperity
			}
		}
		# Check for low prosperity
		AND = {
			$LEVEL$ = low
			has_modifier = low_trade_prosperity
		}
		# Check for medium prosperity
		AND = {
			$LEVEL$ = medium
			has_modifier = medium_trade_prosperity
		}
		# Check for high prosperity
		AND = {
			$LEVEL$ = high
			has_modifier = high_trade_prosperity
		}
	}
}

# Checks if a holding can build a specific type of trade building
can_build_trade_building_trigger = {
	# $BUILDING_TYPE$ = Optional building type (market, trading_post, caravanserai)
	# If no building type is specified, checks for any trade building
	OR = {
		# Basic requirements for any trade building
		AND = {
			NOT = {
				is_variable_set = $BUILDING_TYPE$
			}
			# Basic requirements for trade buildings
			OR = {
				# City holding can build any trade building
				holding_type = city_holding
				# Castle holding can build trading posts and caravanserais
				holding_type = castle_holding
				# Tribal holding can build basic trading posts
				holding_type = tribal_holding
			}
			# Generally need to be on or near a trade route
			county = {
				is_on_silk_road_trigger = yes
			}
		}
		# Market Square - Only in cities with basic infrastructure
		AND = {
			$BUILDING_TYPE$ = market
			# Only cities can have market squares
			holding_type = city_holding
			# Requires basic city development
			has_building = city_01
			# No terrain restrictions for markets
		}
		# Trading Post - Castle or tribal with trade route access
		AND = {
			$BUILDING_TYPE$ = trading_post
			# Castle or tribal only
			OR = {
				holding_type = castle_holding
				holding_type = tribal_holding
			}
			# Must be directly on a trade route
			county = {
				has_county_flag = on_silk_road
			}
		}
		# Caravanserai - Castle or city on major routes in suitable terrain
		AND = {
			$BUILDING_TYPE$ = caravanserai
			# Castle or city only
			OR = {
				holding_type = castle_holding
				holding_type = city_holding
			}
			# Must be on a major route junction
			county = {
				any_trade_node = {
					# Only key nodes qualify
					OR = {
						# Major junction nodes
						node_id = samarkand_node
						node_id = bukhara_node
						node_id = baghdad_node
						node_id = constantinople_node
					}
				}
			}
			# Terrain suitable for caravanserais
			county = {
				OR = {
					terrain = desert
					terrain = drylands
					terrain = plains
					terrain = steppe
					terrain = desert_mountains
				}
			}
		}
	}
}

# Checks if a county is close to a trade route using province adjacency
is_near_trade_route_trigger = {
	# $MAX_DISTANCE$ = Optional maximum distance to check (in provinces)
	# If not provided, defaults to 2 provinces away
	OR = {
		# Direct check - county is on a trade route
		is_on_silk_road_trigger = yes
		# Province-based adjacency check using the adjacency data
		OR = {
			# If no distance is provided, check up to 2 provinces away
			AND = {
				NOT = {
					is_variable_set = $MAX_DISTANCE$
				}
				# Check for adjacent provinces (1 step away)
				any_neighboring_province = {
					county = {
						is_on_silk_road_trigger = yes
					}
				}
				# Check for provinces 2 steps away
				any_neighboring_province = {
					any_neighboring_province = {
						NOT = {
							province_id = root.province_id
						}						# Avoid checking the original
						county = {
							is_on_silk_road_trigger = yes
						}
					}
				}
			}
			# If distance is 1, check only adjacent provinces
			AND = {
				$MAX_DISTANCE$ = 1
				any_neighboring_province = {
					county = {
						is_on_silk_road_trigger = yes
					}
				}
			}
			# If distance is 2, check up to 2 provinces away
			AND = {
				$MAX_DISTANCE$ = 2
				OR = {
					# Check for adjacent provinces (1 step away)
					any_neighboring_province = {
						county = {
							is_on_silk_road_trigger = yes
						}
					}
					# Check for provinces 2 steps away
					any_neighboring_province = {
						any_neighboring_province = {
							NOT = {
								province_id = root.province_id
							}							# Avoid checking the original
							county = {
								is_on_silk_road_trigger = yes
							}
						}
					}
				}
			}
			# If distance is 3, check up to 3 provinces away
			AND = {
				$MAX_DISTANCE$ = 3
				OR = {
					# Check for adjacent provinces (1 step away)
					any_neighboring_province = {
						county = {
							is_on_silk_road_trigger = yes
						}
					}
					# Check for provinces 2 steps away
					any_neighboring_province = {
						any_neighboring_province = {
							NOT = {
								province_id = root.province_id
							}							# Avoid checking the original
							county = {
								is_on_silk_road_trigger = yes
							}
						}
					}
					# Check for provinces 3 steps away
					any_neighboring_province = {
						any_neighboring_province = {
							any_neighboring_province = {
								# Avoid checking the original or doubling back
								NOR = {
									province_id = root.province_id
									province_id = prev.province_id
								}
								county = {
									is_on_silk_road_trigger = yes
								}
							}
						}
					}
				}
			}
		}
	}
}
